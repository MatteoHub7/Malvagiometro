<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malvagiometro</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f5e8cf" />

  <style>
    :root{
      --bg:#f5e8cf;
      --ink:#2b1b12;
      --shadow: rgba(0,0,0,.18);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
    }
    .app{
      width:min(520px, 92vw);
      padding:18px 16px 22px;
      border-radius:18px;
      background: rgba(255,255,255,.55);
      box-shadow: 0 12px 30px var(--shadow);
      border: 2px solid rgba(43,27,18,.15);
    }
    h1{
      margin:0 0 10px;
      text-align:center;
      letter-spacing:.5px;
      font-weight:900;
    }
    .panel{
      display:flex;
      justify-content:center;
      margin: 8px 0 10px;
    }
    .readout{
      text-align:center;
      font-weight:800;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(43,27,18,.18);
    }
    .readout small{ display:block; opacity:.8; font-weight:700; }
    .buttons{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    button{
      appearance:none;
      border: 2px solid rgba(43,27,18,.25);
      background: rgba(255,255,255,.7);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 6px 16px var(--shadow);
    }
    button:active{ transform: translateY(1px); }
    .row{
      display:flex; gap:10px; margin-top:10px;
    }
    .row button{ flex:1; }

    /* ‚Äúvibe‚Äù anni 50: grana + contorno */
    .grain{
      position:relative;
      overflow:hidden;
    }
    .grain:before{
      content:"";
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(0,0,0,.06) 1px, transparent 1px);
      background-size: 6px 6px;
      opacity:.35;
      pointer-events:none;
      mix-blend-mode:multiply;
    }
    svg text{ paint-order: stroke; stroke: rgba(43,27,18,.22); stroke-width: 3px; }
  </style>
</head>

<body>
  <div class="app grain">
    <h1>MALVAGIOMETRO</h1>

    <div class="panel">
      <!-- Gauge SVG (zero immagini, tutto vettoriale) -->
      <svg id="gauge" width="480" height="300" viewBox="0 0 480 300" role="img" aria-label="Malvagiometro">
        <!-- cornice -->
        <path d="M60 240 A180 180 0 0 1 420 240" fill="none" stroke="#2b1b12" stroke-width="18" stroke-linecap="round" opacity=".18"/>
        <path d="M60 240 A180 180 0 0 1 420 240" fill="none" stroke="#2b1b12" stroke-width="6" stroke-linecap="round"/>

        <!-- segmenti -->
        <g id="segments"></g>

        <!-- tacche -->
        <g id="ticks" opacity=".85"></g>

        <!-- etichette -->
        <g id="labels"></g>

        <!-- lancetta -->
        <g id="needle" transform="translate(240 240)">
          <!-- ombra -->
          <line x1="0" y1="0" x2="0" y2="-150" stroke="rgba(0,0,0,.25)" stroke-width="10" stroke-linecap="round" transform="rotate(0) translate(2,2)"/>
          <line id="needleLine" x1="0" y1="0" x2="0" y2="-150" stroke="#c21f1f" stroke-width="10" stroke-linecap="round"/>
          <circle cx="0" cy="0" r="16" fill="#f7d36a" stroke="#2b1b12" stroke-width="6"/>
        </g>

        <!-- base ‚Äúvite‚Äù -->
        <rect x="210" y="250" width="60" height="30" rx="10" fill="#f7d36a" stroke="#2b1b12" stroke-width="6"/>
      </svg>
    </div>

    <div class="readout" id="readout">
      <small>Livello attuale</small>
      <span id="levelName">Disonesta</span>
    </div>

    <div class="buttons">
      <button data-level="0">Angioletta</button>
      <button data-level="1">Birbantella</button>
      <button data-level="2">Disonesta</button>
      <button data-level="3">Bandita</button>
      <button data-level="4">Signora oscura</button>
    </div>

    <div class="row">
      <button id="randomBtn">üé≤ Random</button>
      <button id="installHintBtn">üì≤ Installa</button>
    </div>
  </div>

  <script>
    // ---- Setup gauge ----
    const levels = [
      { name: "Angioletta",     color: "#7ec8ff" },
      { name: "Birbantella",    color: "#9fe7b0" },
      { name: "Disonesta",      color: "#f7d36a" },
      { name: "Bandita",        color: "#ff8a4a" },
      { name: "Signora oscura", color: "#e24a4a" },
    ];

    const cx = 240, cy = 240;
    const rOuter = 180, rInner = 120;
    const startDeg = -180, endDeg = 0;
    const step = (endDeg - startDeg) / levels.length; // 36¬∞

    const segG = document.getElementById("segments");
    const tickG = document.getElementById("ticks");
    const labG = document.getElementById("labels");

    function polarToXY(cx, cy, r, deg){
      const rad = (deg - 90) * Math.PI / 180;
      return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }

    function arcPath(cx, cy, r1, r2, a0, a1){
      const p1 = polarToXY(cx, cy, r1, a0);
      const p2 = polarToXY(cx, cy, r1, a1);
      const p3 = polarToXY(cx, cy, r2, a1);
      const p4 = polarToXY(cx, cy, r2, a0);
      const large = (a1 - a0) <= 180 ? 0 : 1;

      return [
        `M ${p1.x} ${p1.y}`,
        `A ${r1} ${r1} 0 ${large} 1 ${p2.x} ${p2.y}`,
        `L ${p3.x} ${p3.y}`,
        `A ${r2} ${r2} 0 ${large} 0 ${p4.x} ${p4.y}`,
        "Z"
      ].join(" ");
    }

    // segments + labels + ticks
    levels.forEach((lv, i) => {
      const a0 = startDeg + i * step;
      const a1 = startDeg + (i+1) * step;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", arcPath(cx, cy, rOuter, rInner, a0, a1));
      path.setAttribute("fill", lv.color);
      path.setAttribute("stroke", "#2b1b12");
      path.setAttribute("stroke-width", "4");
      segG.appendChild(path);

      // label
      const mid = (a0 + a1)/2;
      const pt = polarToXY(cx, cy, 150, mid);
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", pt.x);
      t.setAttribute("y", pt.y);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("dominant-baseline", "middle");
      t.setAttribute("font-weight", "900");
      t.setAttribute("font-size", "18");
      t.textContent = lv.name;
      labG.appendChild(t);

      // tick at boundary (except first)
      const boundary = a0;
      if(i > 0){
        const o = polarToXY(cx, cy, rOuter, boundary);
        const inn = polarToXY(cx, cy, rInner-8, boundary);
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1", o.x); line.setAttribute("y1", o.y);
        line.setAttribute("x2", inn.x); line.setAttribute("y2", inn.y);
        line.setAttribute("stroke", "#2b1b12");
        line.setAttribute("stroke-width", "4");
        tickG.appendChild(line);
      }
    });

    // ---- Needle control ----
    const needleLine = document.getElementById("needleLine");
    const readoutName = document.getElementById("levelName");

    // angoli centro-segmento (per i 5 livelli)
    const angles = levels.map((_, i) => startDeg + (i + 0.5) * step);

    function setLevel(i){
      i = Math.max(0, Math.min(levels.length-1, i));
      const deg = angles[i];

      // animazione ‚Äúanni 50‚Äù: scatto morbido
      needleLine.animate(
        [{ transform: `rotate(${needleLine.dataset.deg || 0}deg)` },
         { transform: `rotate(${deg}deg)` }],
        { duration: 500, easing: "cubic-bezier(.2,1.2,.3,1)" }
      );

      needleLine.style.transform = `rotate(${deg}deg)`;
      needleLine.dataset.deg = deg;

      readoutName.textContent = levels[i].name;
      localStorage.setItem("malvagiometro_level", String(i));
    }

    document.querySelectorAll("button[data-level]").forEach(btn=>{
      btn.addEventListener("click", ()=> setLevel(parseInt(btn.dataset.level,10)));
    });

    document.getElementById("randomBtn").addEventListener("click", ()=>{
      const i = Math.floor(Math.random() * levels.length);
      setLevel(i);
    });

    document.getElementById("installHintBtn").addEventListener("click", ()=>{
      alert(
        "Per installarlo:\n\n" +
        "iPhone: apri dal browser ‚Üí Condividi ‚Üí Aggiungi a Home.\n" +
        "Android: menu ‚ãÆ ‚Üí Installa app / Aggiungi a schermata Home."
      );
    });

    // ripristina ultimo valore
    const saved = localStorage.getItem("malvagiometro_level");
    setLevel(saved ? parseInt(saved,10) : 2);

    // ---- Service worker ----
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }
  </script>
</body>
</html>
