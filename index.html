<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malvagiometro</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f6e6c9" />

  <style>
    :root{
      --paper:#f6e6c9;
      --cream:#fff2d9;
      --ink:#22140f;
      --shadow: rgba(0,0,0,.25);
      --hot:#d6252c;
      --punch:#ff8a3d;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: var(--paper);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Poster 50s */
    .poster{
      width:min(580px, 94vw);
      border:6px solid var(--ink);
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.20));
      box-shadow: 0 18px 45px var(--shadow);
      padding:16px 16px 18px;
      position:relative;
      overflow:hidden;
    }

    /* Halftone + “carta stampata” */
    .poster::before{
      content:"";
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(0,0,0,.08) 1px, transparent 1px);
      background-size: 7px 7px;
      opacity:.35;
      mix-blend-mode:multiply;
      pointer-events:none;
    }
    .poster::after{
      content:"";
      position:absolute; inset:-40px;
      background: repeating-linear-gradient(22deg,
        rgba(255,255,255,0) 0 12px,
        rgba(255,255,255,.08) 12px 13px);
      opacity:.35;
      transform: rotate(-2deg);
      pointer-events:none;
    }

    header{ text-align:center; position:relative; z-index:1; }

    .titleWrap{
      display:inline-block;
      background: var(--cream);
      border:6px solid var(--ink);
      border-radius:18px;
      padding:10px 14px;
      box-shadow: 0 10px 0 rgba(0,0,0,.14);
      transform: rotate(-1deg);
    }
    h1{
      margin:0;
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:1000;
      font-size: clamp(26px, 4vw, 36px);
    }
    .tagline{
      margin:10px 0 0;
      font-weight:900;
      opacity:.9;
    }

    /* Starburst 50s */
    .burst{
      position:absolute;
      right:-40px; top:-40px;
      width:160px; height:160px;
      background: radial-gradient(circle at 40% 40%, #fff 0 35%, #ffd46a 36% 100%);
      border:6px solid var(--ink);
      transform: rotate(10deg);
      clip-path: polygon(50% 0%, 60% 18%, 82% 8%, 72% 30%, 100% 32%, 78% 46%, 94% 64%,
                         72% 62%, 78% 92%, 58% 74%, 50% 100%, 42% 74%, 22% 92%, 28% 62%,
                         6% 64%, 22% 46%, 0% 32%, 28% 30%, 18% 8%, 40% 18%);
      box-shadow: 0 12px 0 rgba(0,0,0,.12);
      z-index:1;
    }
    .burst span{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.6px;
      font-size:14px;
    }

    .panel{
      display:flex;
      justify-content:center;
      margin:14px 0 10px;
      position:relative;
      z-index:1;
    }

    .readout{
      position:relative;
      z-index:1;
      border:6px solid var(--ink);
      border-radius:20px;
      background: var(--cream);
      box-shadow: 0 12px 0 rgba(0,0,0,.14);
      padding:12px 12px;
      text-align:center;
      margin-top:10px;
    }
    .readout small{
      display:block;
      font-weight:900;
      opacity:.8;
      margin-bottom:6px;
    }
    .readout .big{
      font-weight:1000;
      letter-spacing:.7px;
      text-transform:uppercase;
      font-size:22px;
    }
    .readout .flavor{
      margin-top:8px;
      font-weight:900;
      opacity:.9;
      font-size:14px;
    }

    .btn{
      margin-top:12px;
      width:100%;
      padding:14px 14px;
      border-radius:20px;
      border:6px solid var(--ink);
      background: linear-gradient(180deg, #fff8e9, #ffe0a6);
      box-shadow: 0 14px 0 rgba(0,0,0,.14);
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.8px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{
      transform: translateY(3px);
      box-shadow: 0 11px 0 rgba(0,0,0,.14);
    }
    .pill{
      background: var(--hot);
      color:#fff;
      border:4px solid var(--ink);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      box-shadow: 0 8px 0 rgba(0,0,0,.12);
    }

    /* SVG contorni “cartoon” */
    svg text{
      paint-order: stroke;
      stroke: rgba(34,20,15,.38);
      stroke-width: 4px;
    }
  </style>
</head>

<body>
  <main class="poster">
    <div class="burst"><span>100%<br>RANDOM</span></div>

    <header>
      <div class="titleWrap">
        <h1>Malvagiometro</h1>
      </div>
      <p class="tagline">Premi il bottone. La lancetta ti giudica.</p>
    </header>

    <section class="panel">
      <svg width="540" height="320" viewBox="0 0 540 320" role="img" aria-label="Malvagiometro">
        <!-- pannello -->
        <rect x="26" y="34" width="488" height="260" rx="26" fill="rgba(255,242,217,.85)" stroke="#22140f" stroke-width="7"/>
        <rect x="36" y="44" width="468" height="240" rx="20" fill="rgba(255,255,255,.22)" stroke="rgba(34,20,15,.18)" stroke-width="3"/>

        <!-- cornice arco -->
        <path d="M98 252 A172 172 0 0 1 442 252" fill="none" stroke="#22140f" stroke-width="18" stroke-linecap="round" opacity=".22"/>
        <path d="M98 252 A172 172 0 0 1 442 252" fill="none" stroke="#22140f" stroke-width="8" stroke-linecap="round"/>

        <g id="segments"></g>
        <g id="ticks" opacity=".95"></g>
        <g id="labels"></g>

        <!-- lancetta -->
        <g transform="translate(270 252)">
          <line x1="0" y1="0" x2="0" y2="-140" stroke="rgba(0,0,0,.22)" stroke-width="12" stroke-linecap="round" transform="translate(2,2) rotate(0)"/>
          <line id="needleLine" x1="0" y1="0" x2="0" y2="-140" stroke="#d6252c" stroke-width="12" stroke-linecap="round"/>
          <circle cx="0" cy="0" r="18" fill="#ffd46a" stroke="#22140f" stroke-width="7"/>
          <circle cx="0" cy="0" r="6" fill="#22140f" opacity=".9"/>
        </g>

        <!-- placchetta -->
        <rect x="190" y="270" width="160" height="34" rx="12" fill="#ffd46a" stroke="#22140f" stroke-width="7"/>
        <text x="270" y="293" text-anchor="middle" font-weight="1000" font-size="18">MODELLO 1957</text>
      </svg>
    </section>

    <section class="readout">
      <small>Esito</small>
      <div class="big" id="levelName">—</div>
      <div class="flavor" id="flavor">Premi e vediamo quanto sei… discutibile.</div>
    </section>

    <button class="btn" id="goBtn">
      <span class="pill">1 TAP</span>
      MISURA LA CATTIVERIA
    </button>
  </main>

  <script>
    const levels = [
      { name: "Angioletta",     color: "#7ec8ff", quips: [
        "Sei così buona che insospettisci.",
        "Reato massimo: sorridere troppo.",
        "Potresti adottare anche i problemi degli altri."
      ]},
      { name: "Birbantella",    color: "#9fe7b0", quips: [
        "Caos controllato. Forse.",
        "Piccoli crimini: tipo rubare patatine.",
        "Fai danni, ma con stile."
      ]},
      { name: "Disonesta",      color: "#ffd46a", quips: [
        "La verità ti ha visto e ha fatto dietrofront.",
        "Ottima a ‘dimenticare’ dettagli cruciali.",
        "Sei il motivo per cui esiste la ricevuta."
      ]},
      { name: "Bandita",        color: "#ff8a3d", quips: [
        "Qui si entra con alibi già pronti.",
        "Morale in modalità risparmio energetico.",
        "Il karma ti sta cercando. Con calma…"
      ]},
      { name: "Signora oscura", color: "#e24a4a", quips: [
        "Le tenebre hanno chiesto il tuo CV.",
        "Sì, eri TU la risata in sottofondo.",
        "Il male ti segue… per imparare."
      ]},
    ];

    // Geometria
    const cx = 270, cy = 252;
    const rOuter = 172, rInner = 118;
    const startDeg = -180, endDeg = 0;
    const step = (endDeg - startDeg) / levels.length;

    const segG = document.getElementById("segments");
    const tickG = document.getElementById("ticks");
    const labG = document.getElementById("labels");

    function polarToXY(cx, cy, r, deg){
      const rad = (deg - 90) * Math.PI / 180;
      return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }
    function arcPath(cx, cy, r1, r2, a0, a1){
      const p1 = polarToXY(cx, cy, r1, a0);
      const p2 = polarToXY(cx, cy, r1, a1);
      const p3 = polarToXY(cx, cy, r2, a1);
      const p4 = polarToXY(cx, cy, r2, a0);
      const large = (a1 - a0) <= 180 ? 0 : 1;
      return [
        `M ${p1.x} ${p1.y}`,
        `A ${r1} ${r1} 0 ${large} 1 ${p2.x} ${p2.y}`,
        `L ${p3.x} ${p3.y}`,
        `A ${r2} ${r2} 0 ${large} 0 ${p4.x} ${p4.y}`,
        "Z"
      ].join(" ");
    }

    // Disegna segmenti + label + ticks
    levels.forEach((lv, i) => {
      const a0 = startDeg + i * step;
      const a1 = startDeg + (i+1) * step;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", arcPath(cx, cy, rOuter, rInner, a0, a1));
      path.setAttribute("fill", lv.color);
      path.setAttribute("stroke", "#22140f");
      path.setAttribute("stroke-width", "7");
      segG.appendChild(path);

      const mid = (a0 + a1)/2;
      const pt = polarToXY(cx, cy, 145, mid);
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", pt.x);
      t.setAttribute("y", pt.y);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("dominant-baseline", "middle");
      t.setAttribute("font-weight", "1000");
      t.setAttribute("font-size", "18");
      t.textContent = lv.name.toUpperCase();
      labG.appendChild(t);

      if(i > 0){
        const boundary = a0;
        const o = polarToXY(cx, cy, rOuter, boundary);
        const inn = polarToXY(cx, cy, rInner-10, boundary);
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1", o.x); line.setAttribute("y1", o.y);
        line.setAttribute("x2", inn.x); line.setAttribute("y2", inn.y);
        line.setAttribute("stroke", "#22140f");
        line.setAttribute("stroke-width", "7");
        line.setAttribute("stroke-linecap", "round");
        tickG.appendChild(line);
      }
    });

    const needleLine = document.getElementById("needleLine");
    const levelName = document.getElementById("levelName");
    const flavor = document.getElementById("flavor");

    function setNeedle(deg){
      const from = Number(needleLine.dataset.deg ?? -90);
      needleLine.animate(
        [{ transform: `rotate(${from}deg)` }, { transform: `rotate(${deg}deg)` }],
        { duration: 520, easing: "cubic-bezier(.15,1.4,.25,1)" } // “sproing” cartoon
      );
      needleLine.style.transform = `rotate(${deg}deg)`;
      needleLine.dataset.deg = String(deg);
    }

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function roll(){
      // livello random
      const i = Math.floor(Math.random() * levels.length);

      // angolo random dentro la tacca (non al centro, e non sui bordi)
      const a0 = startDeg + i * step + 4;
      const a1 = startDeg + (i+1) * step - 4;
      let deg = a0 + Math.random() * (a1 - a0);

      // micro jitter “stampato male”
      deg += (Math.random() - 0.5) * 2; // -1..+1

      setNeedle(deg);
      levelName.textContent = levels[i].name.toUpperCase();
      flavor.textContent = pick(levels[i].quips);

      localStorage.setItem("mm_deg", String(deg));
      localStorage.setItem("mm_i", String(i));
    }

    document.getElementById("goBtn").addEventListener("click", roll);

    // ripristino
    const savedDeg = localStorage.getItem("mm_deg");
    const savedI = localStorage.getItem("mm_i");
    if(savedDeg && savedI){
      setNeedle(Number(savedDeg));
      levelName.textContent = levels[Number(savedI)].name.toUpperCase();
      flavor.textContent = "Ultima lettura salvata. Premi per una nuova condanna.";
    } else {
      setNeedle(-90);
    }

    // PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }
  </script>
</body>
</html>
