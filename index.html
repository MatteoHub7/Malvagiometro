<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malvagiometro</title>

  <style>
    :root{
      --paper:#f6e6c9;
      --ink:#22140f;
      --cream:#fff2d9;
      --shadow: rgba(0,0,0,.25);
      --hot:#d6252c;
    }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background:var(--paper);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
    }
    .card{
      width:min(560px,94vw);
      background:rgba(255,255,255,.55);
      border:4px solid var(--ink);
      border-radius:22px;
      padding:14px;
      box-shadow:0 16px 40px var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(0,0,0,.08) 1px, transparent 1px);
      background-size: 7px 7px;
      opacity:.22;
      mix-blend-mode:multiply;
      pointer-events:none;
    }

    .gaugeWrap{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;
      overflow:hidden;
      border-radius:16px;
      background:var(--cream);

      --px: 50%;
      --py: 60.2%;
    }
    .gaugeWrap img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    /* LANCETTA */
    .needle{
      position:absolute;
      left: var(--px);
      top:  var(--py);
      width: 42%;
      height: 18px;
      transform-origin: 0% 50%;
      transform: translateY(-50%) rotate(-165deg);
      transition: transform 260ms ease-out;
      filter: drop-shadow(2px 3px 0 rgba(0,0,0,.25));
      z-index:4;
      pointer-events:none;
    }
    .needle::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, #e24a4a, #b81f24);
      border:4px solid var(--ink);
      border-radius:999px;
      clip-path: polygon(0 0, 90% 0, 100% 50%, 90% 100%, 0 100%);
    }

    /* PERNO */
    .hub{
      position:absolute;
      left: var(--px);
      top: var(--py);
      width: 54px;
      height: 54px;
      transform: translate(-50%,-50%);
      background: radial-gradient(circle at 35% 35%, #ffe9a8, #f0b84f);
      border:6px solid var(--ink);
      border-radius:50%;
      box-shadow:0 10px 0 rgba(0,0,0,.12);
      z-index:5;
      pointer-events:none;
    }

    /* BOTTONE FIGO + immagine (SVG) */
    .btn50{
      position:relative;
      width:100%;
      margin-top:12px;
      padding:18px 14px 14px;
      border-radius:22px;
      border:6px solid var(--ink);
      background: linear-gradient(180deg, #fff6de, #ffd27b);
      box-shadow:0 16px 0 rgba(0,0,0,.16);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
      transform: translateZ(0);
      z-index:2;
    }
    .btn50:active{
      transform: translateY(4px);
      box-shadow:0 12px 0 rgba(0,0,0,.16);
    }

    .btn50 .label{
      display:block;
      font-weight:1000;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:16px;
      text-align:center;
    }
    .btn50 .sub{
      display:block;
      margin-top:6px;
      font-weight:900;
      font-size:12px;
      opacity:.85;
      text-transform:uppercase;
      letter-spacing:.5px;
      text-align:center;
    }

    /* “immagine” del bottone (SVG embedded) */
    .btnIcon{
      width:66px; height:66px;
      margin:0 auto 8px;
      border-radius:16px;
      border:5px solid var(--ink);
      box-shadow:0 10px 0 rgba(0,0,0,.12);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }

    /* Shine */
    .btn50 .shine{
      position:absolute;
      inset:-40px;
      background: linear-gradient(70deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,.35) 45%,
        rgba(255,255,255,0) 60%);
      transform: translateX(-70%) rotate(5deg);
      animation: shine 2.8s infinite;
      pointer-events:none;
      opacity:.8;
    }
    @keyframes shine{
      0%   { transform: translateX(-80%) rotate(5deg); }
      45%  { transform: translateX(130%) rotate(5deg); }
      100% { transform: translateX(130%) rotate(5deg); }
    }

    .pill{
      position:absolute;
      top:-12px;
      right:-10px;
      padding:10px 12px;
      background:var(--hot);
      color:#fff;
      border:5px solid var(--ink);
      border-radius:999px;
      font-weight:1000;
      letter-spacing:.6px;
      transform: rotate(10deg);
      box-shadow:0 10px 0 rgba(0,0,0,.12);
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="gaugeWrap">
      <img src="gauge.PNG" alt="Malvagiometro" />
      <div class="needle" id="needle"></div>
      <div class="hub"></div>
    </div>

    <button id="btn" class="btn50">
      <span class="pill">BIP!</span>
      <div class="btnIcon" id="btnIcon"></div>
      <span class="label">MISURA LA CATTIVERIA</span>
      <span class="sub">tieni premuto per bloccare</span>
      <span class="shine"></span>
    </button>
  </div>

<script>
  const needle = document.getElementById("needle");
  const btn = document.getElementById("btn");
  const btnIcon = document.getElementById("btnIcon");

  // ---------- IMMAGINE BOTTONE (SVG) ----------
  // Un teschietto/cartoon anni 50 con halftone + stelline.
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 220 220">
    <defs>
      <radialGradient id="bg" cx="38%" cy="32%" r="80%">
        <stop offset="0" stop-color="#fff7df"/>
        <stop offset="1" stop-color="#ffd27b"/>
      </radialGradient>
      <pattern id="dots" width="10" height="10" patternUnits="userSpaceOnUse">
        <circle cx="2" cy="2" r="1.2" fill="rgba(0,0,0,.18)"/>
      </pattern>
      <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="4" dy="5" stdDeviation="0" flood-color="rgba(0,0,0,.25)"/>
      </filter>
    </defs>

    <rect x="0" y="0" width="220" height="220" rx="28" fill="url(#bg)"/>
    <rect x="0" y="0" width="220" height="220" rx="28" fill="url(#dots)" opacity="0.55"/>

    <!-- stelline -->
    <g fill="#d6252c" stroke="#22140f" stroke-width="6" filter="url(#shadow)">
      <path d="M35 58 l10 18 20 2 -15 14 4 20 -19-10 -19 10 4-20 -15-14 20-2z" transform="scale(.45) translate(40,35)"/>
      <path d="M35 58 l10 18 20 2 -15 14 4 20 -19-10 -19 10 4-20 -15-14 20-2z" transform="scale(.35) translate(420,130) rotate(15)"/>
    </g>

    <!-- “skull” cartoon -->
    <g filter="url(#shadow)">
      <path d="M110 58
               c-34 0-58 22-58 54
               c0 26 12 34 18 39
               v18 c0 14 12 25 27 25
               h26 c15 0 27-11 27-25
               v-18 c6-5 18-13 18-39
               c0-32-24-54-58-54z"
            fill="#fff2d9" stroke="#22140f" stroke-width="10" stroke-linejoin="round"/>

      <!-- occhi -->
      <ellipse cx="82" cy="116" rx="18" ry="22" fill="#22140f"/>
      <ellipse cx="138" cy="116" rx="18" ry="22" fill="#22140f"/>
      <circle cx="76" cy="112" r="5" fill="#fff2d9" opacity=".9"/>
      <circle cx="132" cy="112" r="5" fill="#fff2d9" opacity=".9"/>

      <!-- naso -->
      <path d="M110 132 l-12 18 h24z" fill="#22140f"/>

      <!-- sorriso cattivo -->
      <path d="M78 152
               q32 22 64 0"
            fill="none" stroke="#22140f" stroke-width="10" stroke-linecap="round"/>

      <!-- dentini -->
      <g stroke="#22140f" stroke-width="6" stroke-linecap="round">
        <line x1="94" y1="160" x2="94" y2="176"/>
        <line x1="110" y1="164" x2="110" y2="180"/>
        <line x1="126" y1="160" x2="126" y2="176"/>
      </g>

      <!-- cornettini -->
      <path d="M64 82 q-18-10 -16-30 q18 10 22 26z" fill="#d6252c" stroke="#22140f" stroke-width="10" stroke-linejoin="round"/>
      <path d="M156 82 q18-10 16-30 q-18 10 -22 26z" fill="#d6252c" stroke="#22140f" stroke-width="10" stroke-linejoin="round"/>
    </g>

    <!-- bordo interno -->
    <rect x="12" y="12" width="196" height="196" rx="22" fill="none" stroke="rgba(34,20,15,.18)" stroke-width="6"/>
  </svg>`;
  const svgDataUrl = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  btnIcon.style.backgroundImage = `url("${svgDataUrl}")`;

  // ---------- ANGOLI ----------
  const ZERO_DEG = -165;

  const levels = [
    { a0: -170, a1: -130 }, // Angioletta
    { a0: -130, a1: -90  }, // Birbantella
    { a0: -90,  a1: -50  }, // Disonesta
    { a0: -50,  a1: -15  }, // Bandita
    { a0: -15,  a1:  10  }  // Signora oscura
  ];

  const rand = (min,max) => min + Math.random()*(max-min);
  const clamp = (x,a,b) => Math.max(a, Math.min(b, x));

  // ---------- AUDIO: bip + evil giggle ----------
  let audioCtx = null;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended") audioCtx.resume();
    return audioCtx;
  }

  function bip(){
    const ctx = ensureAudio();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.value = 800 + Math.random() * 600;
    const t = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.10, t + 0.004);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.035);
    o.connect(g).connect(ctx.destination);
    o.start(t);
    o.stop(t + 0.05);
  }

  // Risatina malvagia "hehe-hehe" (cartoon synth): saw + vibrato + piccoli “syllables”
  function evilGiggle(){
    const ctx = ensureAudio();

    const master = ctx.createGain();
    master.gain.value = 0.0001;
    master.connect(ctx.destination);

    const osc = ctx.createOscillator();
    osc.type = "sawtooth";

    const vib = ctx.createOscillator();
    vib.type = "sine";
    vib.frequency.value = 7.5;

    const vibGain = ctx.createGain();
    vibGain.gain.value = 18; // profondità vibrato (Hz)
    vib.connect(vibGain);
    vibGain.connect(osc.frequency);

    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 1800;
    filter.Q.value = 0.8;

    osc.connect(filter).connect(master);

    const t0 = ctx.currentTime + 0.01;

    // base pitch “cattivo”
    osc.frequency.setValueAtTime(260, t0);
    osc.frequency.linearRampToValueAtTime(340, t0 + 0.10);
    osc.frequency.linearRampToValueAtTime(240, t0 + 0.28);

    // envelope a sillabe: hehe-hehe (4 colpetti)
    const hits = [0.00, 0.10, 0.20, 0.30];
    hits.forEach((dt, k) => {
      const t = t0 + dt;
      const peak = 0.16 - k*0.015;
      master.gain.setValueAtTime(0.0001, t);
      master.gain.exponentialRampToValueAtTime(peak, t + 0.012);
      master.gain.exponentialRampToValueAtTime(0.0001, t + 0.07);

      // piccoli “salti” di pitch per effetto risata
      const base = 260 + k*18;
      osc.frequency.setValueAtTime(base, t);
      osc.frequency.linearRampToValueAtTime(base + 110, t + 0.04);
      osc.frequency.linearRampToValueAtTime(base - 30, t + 0.08);
    });

    vib.start(t0);
    osc.start(t0);
    osc.stop(t0 + 0.42);
    vib.stop(t0 + 0.42);
  }

  // ---------- GEIGER NEEDLE ----------
  let currentDeg = ZERO_DEG;
  let targetDeg  = ZERO_DEG;
  let geigerTimer = null;
  let settleTimer = null;
  let holding = false;
  let giggledThisPress = false;

  function setNeedleInstant(deg){
    currentDeg = deg;
    needle.style.transition = "none";
    needle.style.transform = `translateY(-50%) rotate(${deg}deg)`;
  }

  function setNeedleSmooth(deg, ms=260){
    currentDeg = deg;
    needle.style.transition = `transform ${ms}ms ease-out`;
    needle.style.transform = `translateY(-50%) rotate(${deg}deg)`;
  }

  function stopGeiger(){
    if(geigerTimer){ clearInterval(geigerTimer); geigerTimer = null; }
    if(settleTimer){ clearTimeout(settleTimer); settleTimer = null; }
  }

  function randomTarget(){
    const i = Math.floor(Math.random() * levels.length);
    const lv = levels[i];
    return rand(lv.a0, lv.a1) + rand(-2, 2);
  }

  function startGeigerTo(target){
    stopGeiger();
    targetDeg = target;
    needle.style.transition = "none";

    geigerTimer = setInterval(() => {
      const dist = targetDeg - currentDeg;

      // vicino al target: vibra + bip più lento
      if(Math.abs(dist) < 2.2){
        const jitter = rand(-1.8, 1.8);
        const d = clamp(targetDeg + jitter, -180, 15);
        needle.style.transform = `translateY(-50%) rotate(${d}deg)`;

        if(Math.random() < 0.55) bip();

        // risatina UNA VOLTA quando “aggancia” il target (solo se molto cattivo)
        // qui: se il target è oltre -35° (zona Bandita/Signora oscura), parte la giggle
        if(!giggledThisPress && targetDeg > -35){
          giggledThisPress = true;
          evilGiggle();
        }

        // se non tengo premuto, poi rientra
        if(!holding){
          stopGeiger();
          settleTimer = setTimeout(() => setNeedleSmooth(ZERO_DEG, 320), 220);
        }
        return;
      }

      const step = clamp(Math.abs(dist) * 0.22, 1.2, 10.0);
      const dir = Math.sign(dist);
      const micro = rand(-0.9, 0.9);

      const next = currentDeg + dir * step + micro;
      currentDeg = next;

      needle.style.transform = `translateY(-50%) rotate(${next}deg)`;
      if(Math.random() < 0.75) bip();
    }, Math.floor(rand(28, 55)));
  }

  function onPressStart(ev){
    ev.preventDefault();
    holding = true;
    giggledThisPress = false;
    ensureAudio(); // sblocca audio su iOS
    startGeigerTo(randomTarget());
  }

  function onPressEnd(){
    if(!holding) return;
    holding = false;
    stopGeiger();
    setNeedleSmooth(ZERO_DEG, 420);
  }

  // pointer + fallback touch
  btn.addEventListener("pointerdown", onPressStart);
  btn.addEventListener("pointerup", onPressEnd);
  btn.addEventListener("pointercancel", onPressEnd);
  btn.addEventListener("pointerleave", onPressEnd);

  btn.addEventListener("touchstart", onPressStart, { passive:false });
  btn.addEventListener("touchend", onPressEnd);
  btn.addEventListener("touchcancel", onPressEnd);

  setNeedleInstant(ZERO_DEG);
</script>
</body>
</html>
